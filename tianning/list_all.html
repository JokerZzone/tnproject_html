<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>项目列表</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">
		<!--App自定义的css-->
		<!--<link rel="stylesheet" type="text/css" href="css/app.css" />-->
		<style>
			ul {
				padding: 0;
			}
			ul li {
				list-style: none;
			}
			.mui-table-view-cell:after {
				right: 15px;
			}
			.essentials {
				height: 35px;
				margin:-10px 10px 10px 10px;
				/*border:1px solid #ccc;*/
				border-radius: 5px;
				position: relative;
				overflow: hidden;
			}
			.essentials_left {
				width: 50px;
				height: 35px;
				line-height: 35px;
				text-align: center;
				color: #666;
				font-size: 14px;
			}
			.essentials_main {
				position: absolute;
				width: 100%;
				height: 35px;
				top: 0;
				left: 0;
				margin: 0;
				/*padding-left:55px;*/
				font-size: 12px;
			}
			.essentials_main marquee {
				line-height: 35px;
			}
			.essentials span {
				color:#FF0000;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background: #4BAFFA;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color:#fff;"></a>
			<h1 id="data_title" class="mui-title" style="color:#fff"></h1>
		</header>
		<div id="pullrefresh" class="mui-content" style="background: #fff;">
			<div class="mui-input-row mui-search" style="margin:0 auto;margin-top: 5px;width: 95%;">
			    <input id="projectSearch" type="search" class="mui-input-clear" placeholder="请输入项目名称">
			</div>
			<div class="essentials">
				<div class="essentials_main">
				<marquee>
					<span id="buildPlaceName"></span>共<span id="projectNumber">26</span>个项目，
					<span id="">2018</span>年计划投资<span id="">36.7</span>亿元,
					其中<span id="">3</span>个续建项目，
					<span id="">2018</span>年计划投资<span id="">6.4</span>亿元；
					<span id="">23</span>个新建项目，
					<span id="">2018</span>年计划投资<span id="">30.3</span>亿元。
				</marquee>
				</div>
			</div>
			<ul id="OA_task_1" class="mui-table-view" style="margin: 0;">
				<li id="" class="mui-table-view-cell list_all_data" style="display: none;">
					<div class="mui-slider-right mui-disabled roleControl">
						<a class="mui-btn mui-btn-red">删除</a>
					</div>
					<div class="mui-slider-handle">
						<a id="list_all_a" class="mui_row_ul list_all_a mui-pull-left mui-col-xs-10" href="#" style="display:block;height:45px; color:#333;">
							<span class="mui-col-xs-2 list1 mui-pull-left mui-text-center" style="display:block;line-height:45px;">1</span>
							<span class="mui-col-xs-10 list2 mui-pull-left" style="display:block;line-height:45px;" name="name">2</span>
						</a>
							<span class="location mui-icon mui-icon-location mui-pull-left mui-col-xs-2 mui-text-center" style="display:block;color:#0090ff;line-height: 45px;"></span>
					</div>
				</li>
			</ul>
		</div>
		<script src="js/url.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/mui.pullToRefresh.js"></script>
		<script src="js/mui.pullToRefresh.material.js"></script>
		<script>
			mui.init({
			beforeback: function(){
				//获得列表界面的webview
				var list = plus.webview.getWebviewById('list');
				//触发列表界面的自定义事件（refresh）,从而进行数据刷新
				mui.fire(list,'refresh');
				//返回true，继续页面关闭逻辑
				return true;
			}
		});
		var year = localStorage.getItem('year');
		var month = localStorage.getItem('month');
//      获取页面url的type和content
			function getUrlParam(key){
			    // 获取参数
			    var url = window.location.search;
			    // 正则筛选地址栏
			    var reg = new RegExp("(^|&)"+ key +"=([^&]*)(&|$)");
			    // 匹配目标参数
			    var result = url.substr(1).match(reg);
			    //返回参数值
			    return result ? decodeURIComponent(result[2]) : null;
			}
			var type=getUrlParam("type");
			var content = getUrlParam("content");
			var titleName = getUrlParam("titleName");
			if(content=="全部项目"){
				type=0;
				content="null";
			}else if(content=="全部"){
				type=0;
				content="null";
			}
//			页面加载数据
			mui.ready(function(){
				loading();
				essentials();
			})
			function  getRoleIdByUserName(token){
				mui.ajax(commonUrl+'/android/role/listByUsername;jsessionid='+token,{
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					async:false, 
				     success: function(data) {
						if(data.code=='1'){
							sessionStorage.setItem("roleId",data.data[0].id);
						}
					}
				});
			}
				
//  项目列表加载
		function loading(){
			var token = sessionStorage.getItem('token');
			getRoleIdByUserName(token);
			mui.ajax(commonUrl+'/android/project/listByTypeAndName;jsessionid='+token,{
					data:{
						type:type,
						name:content
					},
//					dataType:'json',//服务器返回json格式数据
					type:'post',//HTTP请求类型
					timeout:10000,//超时时间设置为10秒；
//					headers:{'Content-Type':'application/json'},	              
					success:function(data){
//						console.log(data);
						if(data.code==1){
							$("#data_title").html(titleName);
							$("#projectNumber").html(data.data.length);
							
							for(var i=0;i<data.data.length;i++){
								var list_all_data = $(".list_all_data").first().clone();
								$("#OA_task_1").append(list_all_data);
								list_all_data.show();
								list_all_data.find(".list1").html(i+1);
								list_all_data.find(".list2").html(data.data[i].name);
								list_all_data.find(".list_all_a").attr("id",data.data[i].id);
								list_all_data.find(".list_all_a").attr("kay",data.data[i].name);
								list_all_data.find(".list_all_a").attr("lockstatus",data.data[i].lockStatus);
								list_all_data.find(".mui-icon-location").attr("id",data.data[i].id);
							}
							
							if(sessionStorage.getItem('roleId')==1||sessionStorage.getItem('roleId')==11){
								//显示删除按钮
								$(".roleControl").remove();
							}else{
								
								$(".roleControl").remove();
							}
						}else{
							mui.alert("加载数据失败");
						}
					},
					error:function(xhr,type,errorThrown){
						//异常处理；
						console.log(type);
					}
				});
		}
//		滑动删除
			(function($) {
				//第一个demo，拖拽后显示操作图标，点击操作图标删除元素；
				$('#OA_task_1').on('tap', '.mui-btn', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					mui.confirm('确认删除该条记录？', '', btnArray, function(e) {
						if (e.index == 0) {
							li.parentNode.removeChild(li);
						} else {
							setTimeout(function() {
								$.swipeoutClose(li);
							}, 0);
						}
					});
				});
				var btnArray = ['确认', '取消'];
			})(mui);
			
//		点击进入详情列表页面
		mui("#OA_task_1").on('tap', '.list_all_a', function() {
				//获取id
			var id = this.getAttribute("id");
			var titleName = this.getAttribute("kay");
			var lockstatus = this.getAttribute("lockstatus");
			mui.openWindow({
			    url: 'list_all_data.html?id='+id+'&titleName='+titleName+'&lockstatus='+lockstatus, 
			    id:'list_all_data_detail'
			  });
			})
		mui("#OA_task_1").on('tap', '.mui-icon-location', function() {
				//获取id
			var id = this.getAttribute("id");
				mui.openWindow({
				    url: 'map.html?id='+id, 
				    id:'map'
				  });
			})
	
	
//  手机键盘搜索
	document.getElementById("projectSearch").addEventListener("keypress",function(event) {
    if(event.keyCode == "13") {
       document.activeElement.blur();//收起虚拟键盘
     
     	var ProjectSearchName = document.getElementById("projectSearch").value;
		var token = sessionStorage.getItem('token');
    	mui.ajax(commonUrl+'/android/project/projectSearch;jsessionid='+token,{
			data:{
				type:type,
				name:content,
				content:ProjectSearchName
			},
			type:'post',//HTTP请求类型
			timeout:10000,//超时时间设置为10秒；
			success:function(data){
				//服务器返回响应，根据响应结果，分析是否登录成功；
//				console.log(data);
				if(data.code==1){
					$("#OA_task_1").find(".list_all_data").remove();
					if(data.data.length==0){
						mui.alert("没有相关的项目");
					}
					for(var i=0;i<data.data.length;i++){
						console.log(data.data[i].name);
						var str ="";
						str = '<li class="mui-table-view-cell list_all_data">'+
							'<div class="mui-slider-right mui-disabled roleControl">'+
								'<a class="mui-btn mui-btn-red">删除</a>'+
							'</div>'+
							'<div class="mui-slider-handle">'+
								'<a id="'+data.data[i].id+'" class="mui_row_ul list_all_a mui-pull-left mui-col-xs-10" href="#" style="display:block;height:45px; color:#333;" kay="'+data.data[i].name+'" lockstatus="'+data.data[i].lockstatus+'">'+
									'<span class="mui-col-xs-2 list1 mui-pull-left mui-text-center" style="display:block;line-height:45px;">'+(i+1)+'</span>'+
									'<span class="mui-col-xs-10 list2 mui-pull-left" style="display:block;line-height:45px;" name="name">'+data.data[i].name+'</span>'+
								'</a>'+
									'<span id="'+data.data[i].id+'" class="location mui-icon mui-icon-location mui-pull-left mui-col-xs-2 mui-text-center" style="display:block;color:#0090ff;line-height: 45px;"></span>'+
							'</div>'+
						'</li>'
						$("#OA_task_1").append(str);
					}
				  ProjectSearchName = "";
				}
			},
			error:function(){
				//异常处理；
				alert("没有查询到项目名称");
			}
		});
      
//    	toSearch();//TODO 完成搜索事件
        event.preventDefault(); // 阻止默认事件---阻止页面刷新
        
    	}
	});
//  概要
	function essentials(){
		mui.ajax(commonUrl+'/android/summary/showSummary',{
			data:{
				buildPlaceName:content,
				year:2018
			},
			type:'post',//HTTP请求类型
			timeout:10000,//超时时间设置为10秒；
			success:function(data){
				//服务器返回响应，根据响应结果，分析是否登录成功；
				if(data.code==1){
				console.log(data);
				$("#buildPlaceName").html(data.data.buildPlaceName);
				$("#property1Count").html(data.data.buildPlaceName);
				
				}
			},
			error:function(xhr,type,errorThrown){
				//异常处理；
				console.log(type);
			}
		});
	}
	
		</script>
	
	</body>

</html>